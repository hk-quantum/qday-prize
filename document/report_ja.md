# 量子回路の詳細



## oracleの詳細

$aG+bQ$の実現方法として、Version 2では量子ゲート数を大幅に削減することができた。  
以下に Version 1 と Version 2 の違いを示す。

Version 1では、古典計算された $G^1, G^2, G^4$ や $Q^1, Q^2, Q^4$ を、量子レジスタ $\ket{a_2 a_1 a_0}$ や $\ket{b_2 b_1 b_0}$ の対応するビットを制御ビットして逐次足し算していた。

```
 qa_0: ────■─────────────────────────────────────────────────
           │                                                 
 qa_1: ────┼────────■────────────────────────────────────────
           │        │                                        
 qa_2: ────┼────────┼────────■───────────────────────────────
           │        │        │                               
 qb_0: ────┼────────┼────────┼────────■──────────────────────
           │        │        │        │                      
 qb_1: ────┼────────┼────────┼────────┼────────■─────────────
           │        │        │        │        │             
 qb_2: ────┼────────┼────────┼────────┼────────┼────────■────
       ┌───┴───┐┌───┴───┐┌───┴───┐┌───┴───┐┌───┴───┐┌───┴───┐
   qx: ┤0      ├┤0      ├┤0      ├┤0      ├┤0      ├┤0      ├
       │       ││       ││       ││       ││       ││       │
   qy: ┤1      ├┤1      ├┤1      ├┤1      ├┤1      ├┤1      ├
       │       ││       ││       ││       ││       ││       │
anc_0: ┤2 +G^1 ├┤2 +G^2 ├┤2 +G^4 ├┤2 +Q^1 ├┤2 +Q^2 ├┤2 +Q^4 ├
       │       ││       ││       ││       ││       ││       │
anc_1: ┤3      ├┤3      ├┤3      ├┤3      ├┤3      ├┤3      ├
       │       ││       ││       ││       ││       ││       │
anc_2: ┤4      ├┤4      ├┤4      ├┤4      ├┤4      ├┤4      ├
       └───────┘└───────┘└───────┘└───────┘└───────┘└───────┘
```

一方、Version 2では、各ビットごとに $a_i G^{2^i} + b_i Q^{2^i}$ を古典計算で実施して量子レジスタに埋め込んだ。

```math
\ket{a_i}\ket{b_i}=\ket{1}\ket{0}G^{2^i}+\ket{0}\ket{1}Q^{2^i}+\ket{1}\ket{1}(G^{2^i}+Q^{2^i})
```

このように、ビットの組み合わせはたかだか3つなので、量子レジスタへの埋め込みはシンプルに実現できる。

この埋め込んだ量子レジスタを足し算に利用する方法で複雑な量子回路となるECC足し算の回数を大幅に削減した。  
(3bitを例にすると、6回の足し算が2回に減った)

```
 qa_0: ───────■──────────────────────────────────────────────────────────────────────────────────────────
              │                                                                                          
 qa_1: ───────┼─────────────────■────────────────────────────────────────────────────────────────────────
              │                 │                                                                        
 qa_2: ───────┼─────────────────┼───────────────────■────────────────────────────────────────────────────
              │                 │                   │                                                    
 qb_0: ───────■─────────────────┼───────────────────┼────────────────────────────────────────────────────
              │                 │                   │                                                    
 qb_1: ───────┼─────────────────■───────────────────┼────────────────────────────────────────────────────
              │                 │                   │                                                    
 qb_2: ───────┼─────────────────┼───────────────────■────────────────────────────────────────────────────
       ┌──────┴───────┐         │                   │          ┌───────────────────┐┌───────────────────┐
   qx: ┤0             ├─────────┼───────────────────┼──────────┤0                  ├┤0                  ├
       │  a_0*G+b_0*Q │         │                   │          │                   ││                   │
   qy: ┤1             ├─────────┼───────────────────┼──────────┤1                  ├┤1                  ├
       └──────────────┘         │                   │          │                   ││                   │
anc_0: ─────────────────────────┼───────────────────┼──────────┤2 +a_1*G^2+b_1*Q^2 ├┤2 +a_2*G^4+b_2*Q^4 ├
                                │                   │          │                   ││                   │
anc_1: ─────────────────────────┼───────────────────┼──────────┤3                  ├┤3                  ├
                                │                   │          │                   ││                   │
anc_2: ─────────────────────────┼───────────────────┼──────────┤4                  ├┤4                  ├
                       ┌────────┴─────────┐         │          └─────────┬─────────┘└─────────┬─────────┘
  qx2: ────────────────┤0                 ├─────────┼────────────────────■────────────────────┼──────────
                       │  a_1*G^2+b_1*Q^2 │         │                    │                    │          
  qy2: ────────────────┤1                 ├─────────┼────────────────────■────────────────────┼──────────
                       └──────────────────┘┌────────┴─────────┐                               │          
  qx4: ────────────────────────────────────┤0                 ├───────────────────────────────■──────────
                                           │  a_2*G^4+b_2*Q^4 │                               │          
  qy4: ────────────────────────────────────┤1                 ├───────────────────────────────■──────────
                                           └──────────────────┘                                          
```

この方法は、量子ゲート数の削減と共に、最初の量子レジスタへの埋め込みは並列で実施可能なことから、量子回路の深さも削減する効果がある。

## 座標の足し算

複雑な座標同士の足し算は、以下の量子回路で実現した。

```
  qx1: ─────────■───────────X───────────────────────■────────────────────
                │           │                       │                    
  qy1: ─────────■───────────┼──X────────────────────■────────────────────
                │           │  │                    │                    
  qx2: ─────────■───────────┼──┼────────────────────■────────────────────
                │           │  │ ┌──────┐           │            ┌──────┐
  qy2: ─────────■───────────┼──┼─┤ -qy2 ├───────────■────────────┤ -qy2 ├
       ┌────────┴─────────┐ │  │ └──────┘┌──────────┴───────────┐└──────┘
   ox: ┤0                 ├─X──┼─────────┤0                     ├────────
       │                  │    │         │                      │        
   oy: ┤1                 ├────X─────────┤1                     ├────────
       │                  │              │                      │        
anc_0: ┤2 (x1,y1)+(x2,y2) ├──────────────┤2 inv (x1,y1)+(x2,y2) ├────────
       │                  │              │                      │        
anc_1: ┤3                 ├──────────────┤3                     ├────────
       │                  │              │                      │        
anc_2: ┤4                 ├──────────────┤4                     ├────────
       └──────────────────┘              └──────────────────────┘        
```

- 入力 $(qx1, qy1)$ と $(qx2, qy2)$ を足し算した結果を $(ox, oy)$ に格納する
- $(qx1, qy1)$ と $(ox, oy)$ をswapする
- 引き算のために $qy2$ を $-qy2 = p - qy2$ と符号を逆転させる
- この状態で $(qx1, qy1)+(qx2, qy2)$ の逆回路を実行することで、$ox, oy, anc$ をすべて $\ket{0}$ に戻す

この足し算回路では以下の ancilla ビットを用意した。

- 以下の状態を示すフラグ 4つ(1ビットずつ)
  - $(qx1, qy1)=O$
  - $(qx2, qy2)=O$
  - $(qx1, qy1)=-(qx2, qy2)$
  - $(qx, qy)=(qx2, qy2)$
- $dx:=(qx1-qx2) \mod{p}$
- $dy:=(qy1-qy2) \mod{p}$
- $dx^{-1}:=dx^{p-2} \mod{p}$
  - $dx^2,dx^4,dx^8...$ と $p-2$ の最上位ビットまでの冪乗を保持する量子ビットを追加で用意する
  - 一時計算用の量子レジスタも用意する
- $\lambda:=dx^{-1} \cdot dy \mod{p}$
- $\lambda \cdot ox$ ($oy$の計算用)
- 1ビットのキャリービット(各種計算で使う addr mod で利用)
